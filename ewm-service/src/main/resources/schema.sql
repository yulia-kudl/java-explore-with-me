CREATE TABLE IF NOT EXISTS categories (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  name VARCHAR(50) UNIQUE,
  CONSTRAINT pk_categories PRIMARY KEY (id)
);
CREATE TABLE IF NOT EXISTS users (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  name VARCHAR(50),
  email VARCHAR(50) UNIQUE,
  CONSTRAINT pk_users PRIMARY KEY (id)
);
CREATE TABLE IF NOT EXISTS compilations (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  title VARCHAR(50) NOT NULL UNIQUE,
  pinned BOOLEAN DEFAULT FALSE,
  CONSTRAINT pk_compilations PRIMARY KEY (id)
);
CREATE TABLE IF NOT EXISTS locations (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    lat FLOAT NOT NULL,
    lon FLOAT NOT NULL
    );
CREATE UNIQUE INDEX IF NOT EXISTS uq_locations_lat_lon
ON locations(lat, lon);

CREATE TABLE IF NOT EXISTS events (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  annotation TEXT NOT NULL,
  category_id BIGINT REFERENCES categories(id) NOT NULL,
  confirmed_requests BIGINT DEFAULT 0,
  created_on TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  description TEXT,
  event_date TIMESTAMP NOT NULL,
  initiator_id BIGINT REFERENCES users(id) NOT NULL,
  location_id BIGINT REFERENCES locations(id) NOT NULL,
  paid BOOLEAN DEFAULT FALSE,
  participant_limit INTEGER DEFAULT 0,
  published_on TIMESTAMP,
  request_moderation BOOLEAN DEFAULT TRUE,
  state VARCHAR(20) DEFAULT 'PENDING',
  title TEXT NOT NULL,
  available BOOLEAN DEFAULT TRUE,
  views BIGINT DEFAULT 0,
  CONSTRAINT pk_events PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS compilations_events (
  event_id BIGINT REFERENCES events(id) ON DELETE CASCADE,
  compilation_id BIGINT REFERENCES compilations(id) ON DELETE CASCADE,
  CONSTRAINT pk_compilation_events PRIMARY KEY (compilation_id, event_id)
);

CREATE TABLE IF NOT EXISTS requests (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  event_id BIGINT REFERENCES events(id) NOT NULL,
  user_id BIGINT REFERENCES users(id) NOT NULL,
  status VARCHAR(15) NOT NULL,
  CONSTRAINT pk_requests PRIMARY KEY (id)
);
